<% if @error %>
  <div class="p-3 bg-red-900/50 text-red-300 rounded text-sm"><%= @error %></div>
<% end %>

<% if flash[:alert].present? %>
  <div class="p-3 bg-amber-900/50 text-amber-300 rounded text-sm">
    <%= flash[:alert] %>
    <%= link_to t("sidebar.upgrade"), plans_path, class: "underline font-medium ml-1" %>
  </div>
<% end %>

<% unless can_run_optimization? %>
  <div class="p-3 bg-amber-900/50 text-amber-300 rounded text-sm">
    <%= t("limits.daily_optimizations_reached") %>
    <%= link_to t("sidebar.upgrade"), plans_path, class: "underline font-medium ml-1" %>
  </div>
<% end %>

<%= form_with url: form_url, method: form_method, class: "space-y-10" do |f| %>

  <%# Pieces to Cut %>
  <section data-controller="pieces">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wide"><%= t("projects.index.pieces_to_cut") %></h2>
      <input type="file" accept=".csv,.tsv,.txt" class="hidden" data-pieces-target="csvInput" data-action="change->pieces#importCsv">
      <button type="button" data-action="pieces#openCsvDialog"
              class="text-sm text-blue-400 hover:text-blue-300 font-medium">
        <%= t("projects.index.import_csv") %>
      </button>
    </div>

    <table class="w-full text-left border-collapse text-sm">
      <thead>
        <tr class="border-b border-gray-700">
          <th class="py-1 pr-2 text-gray-400"><%= t("projects.index.width_short") %></th>
          <th class="py-1 pr-2 text-gray-400"><%= t("projects.index.height_short") %></th>
          <th class="py-1 pr-2 text-gray-400"><%= t("projects.index.quantity_short") %></th>
          <th class="py-1 pr-2 text-gray-400"><%= t("projects.index.rotation_short") %></th>
          <th class="py-1 w-8"></th>
        </tr>
      </thead>
      <tbody data-pieces-target="body">
        <% pieces = @pieces.presence || [{ length: nil, height: nil, quantity: 1, allow_rotate: "1" }] %>
        <% pieces.each do |piece| %>
          <tr class="border-b border-gray-800">
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][length]" min="1" step="any" required
                     value="<%= piece[:length] || piece["length"] %>"
                     class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][height]" min="1" step="any" required
                     value="<%= piece[:height] || piece["height"] %>"
                     class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][quantity]" min="1" value="<%= piece[:quantity] || piece["quantity"] || 1 %>" required
                     class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2 text-center">
              <input type="hidden" name="pieces[][allow_rotate]" value="0">
              <% rotate_val = piece[:allow_rotate] || piece["allow_rotate"] %>
              <input type="checkbox" name="pieces[][allow_rotate]" value="1" <%= "checked" if rotate_val != "0" && rotate_val != false %>
                     class="h-4 w-4 rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500">
            </td>
            <td class="py-1">
              <button type="button" data-action="pieces#remove"
                      class="text-red-400 hover:text-red-300 text-xs font-medium">
                &times;
              </button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <template data-pieces-target="template">
      <tr class="border-b border-gray-800">
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][length]" min="1" step="any" required
                 class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][height]" min="1" step="any" required
                 class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][quantity]" min="1" value="1" required
                 class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2 text-center">
          <input type="hidden" name="pieces[][allow_rotate]" value="0">
          <input type="checkbox" name="pieces[][allow_rotate]" value="1" checked
                 class="h-4 w-4 rounded border-gray-600 bg-gray-900 text-blue-500 focus:ring-blue-500">
        </td>
        <td class="py-1">
          <button type="button" data-action="pieces#remove"
                  class="text-red-400 hover:text-red-300 text-xs font-medium">
            &times;
          </button>
        </td>
      </tr>
    </template>

    <button type="button" data-action="pieces#add"
            class="mt-2 text-sm text-white hover:text-gray-300 font-medium">
      <%= t("projects.index.add_piece") %>
    </button>
  </section>

  <%# Stock Sheet %>
  <section>
    <h2 class="text-sm font-semibold mb-2 text-gray-400 uppercase tracking-wide"><%= t("projects.index.stock_sheet") %></h2>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label for="stock_w" class="block text-xs font-medium text-gray-400 mb-1"><%= t("projects.index.width") %></label>
        <input type="number" id="stock_w" name="stock_w" min="1" step="any" required
               value="<%= @stock_w %>"
               class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label for="stock_h" class="block text-xs font-medium text-gray-400 mb-1"><%= t("projects.index.height") %></label>
        <input type="number" id="stock_h" name="stock_h" min="1" step="any" required
               value="<%= @stock_h %>"
               class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
  </section>

  <%# Kerf %>
  <section>
    <h2 class="text-sm font-semibold mb-2 text-gray-400 uppercase tracking-wide"><%= t("projects.index.blade_kerf") %></h2>
    <input type="number" name="kerf" min="0" step="any" value="<%= @kerf || 0 %>"
           class="w-full bg-gray-900 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
    <p class="text-xs text-gray-500 mt-1"><%= t("projects.index.kerf_hint") %></p>
  </section>

  <button type="submit"
          class="w-full bg-white text-gray-950 px-4 py-2 rounded hover:bg-gray-200 font-medium text-sm">
    <%= t("projects.index.optimize") %>
  </button>
<% end %>
