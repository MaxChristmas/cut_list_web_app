<% if @error %>
  <div class="p-3 bg-red-900/50 text-red-300 rounded text-sm"><%= @error %></div>
<% end %>

<% if flash[:alert].present? %>
  <div class="p-3 bg-amber-900/50 text-amber-300 rounded text-sm">
    <%= flash[:alert] %>
    <%= link_to t("sidebar.upgrade"), plans_path, class: "underline font-medium ml-1" %>
  </div>
<% end %>

<% unless can_run_optimization?(@project) %>
  <div class="p-3 bg-amber-900/50 text-amber-300 rounded text-sm">
    <%= t("limits.monthly_optimizations_reached") %>
    <%= link_to t("sidebar.upgrade"), plans_path, class: "underline font-medium ml-1" %>
  </div>
<% end %>

<%= form_with url: form_url, method: form_method, class: "space-y-10" do |f| %>
  <section>
    <input type="text" name="name" value="<%= @name %>"
           placeholder="<%= t("projects.index.project_name") %>"
           class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
           maxlength="100">
  </section>

  <% has_labels = @pieces.present? && @pieces.any? { |p| (p[:label] || p["label"]).present? } %>
  <section data-controller="pieces" data-pieces-labels-visible-value="<%= has_labels %>">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-sm font-semibold uppercase tracking-wide"><%= t("projects.index.pieces_to_cut") %></h2>
      <div class="flex items-center gap-4">
        <% if has_feature?(:label_pieces) %>
          <label class="flex items-center gap-1.5 cursor-pointer">
            <input type="checkbox" data-pieces-target="labelsToggle" data-action="pieces#toggleLabels"
                   <%= "checked" if has_labels %>
                   class="h-3.5 w-3.5 rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-blue-500">
            <span class="text-xs text-gray-400"><%= t("projects.index.show_labels") %></span>
          </label>
        <% end %>
        <% if has_feature?(:import_csv) %>
          <input type="file" accept=".csv,.tsv,.txt" class="hidden" data-pieces-target="csvInput" data-action="change->pieces#importCsv">
          <button type="button" data-action="pieces#openCsvDialog"
                  class="text-sm text-white hover:text-blue-300 font-medium">
            <%= t("projects.index.import_csv") %>
          </button>
        <% end %>
      </div>
    </div>

    <table class="w-full text-left border-collapse text-sm">
      <thead>
        <tr class="border-b border-gray-700">
          <th class="py-1 pr-2 font-light"><%= t("projects.index.length_short") %></th>
          <th class="py-1 pr-2 font-light"><%= t("projects.index.width_short") %></th>
          <th class="py-1 pr-2 font-light"><%= t("projects.index.quantity_short") %></th>
          <th class="py-1 pr-2 font-light" data-pieces-target="labelCol" <%= 'hidden' unless has_labels %>><%= t("projects.index.label_short") %></th>
          <th class="py-1 w-8 font-light"></th>
        </tr>
      </thead>
      <tbody data-pieces-target="body">
        <% pieces = @pieces.presence || [{ length: nil, width: nil, quantity: 1 }] %>
        <% pieces.each do |piece| %>
          <tr class="border-b border-gray-800">
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][length]" min="1" step="any" required
                     value="<%= piece[:length] || piece["length"] %>"
                     class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][width]" min="1" step="any" required
                     value="<%= piece[:width] || piece["width"] %>"
                     class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2">
              <input type="number" name="pieces[][quantity]" min="1" value="<%= piece[:quantity] || piece["quantity"] || 1 %>" required
                     class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1 pr-2" data-pieces-target="labelCol" <%= 'hidden' unless has_labels %>>
              <input type="text" name="pieces[][label]" maxlength="20"
                     value="<%= piece[:label] || piece["label"] %>"
                     class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="py-1">
              <button type="button" data-action="pieces#remove"
                      class="text-red-400 hover:text-red-300 text-xs font-medium">
                &times;
              </button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <template data-pieces-target="template">
      <tr class="border-b border-gray-800">
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][length]" min="1" step="any" required
                 class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][width]" min="1" step="any" required
                 class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2">
          <input type="number" name="pieces[][quantity]" min="1" value="1" required
                 class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1 pr-2" data-pieces-target="labelCol" hidden>
          <input type="text" name="pieces[][label]" maxlength="20"
                 class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </td>
        <td class="py-1">
          <button type="button" data-action="pieces#remove"
                  class="text-red-400 hover:text-red-300 text-xs font-medium">
            &times;
          </button>
        </td>
      </tr>
    </template>

    <button type="button" data-action="pieces#add"
            class="mt-2 text-sm text-white hover:text-gray-300 font-medium">
      <%= t("projects.index.add_piece") %>
    </button>
  </section>

  <%# Stock Sheet %>
  <section>
    <h2 class="text-sm font-semibold mb-2 uppercase tracking-wide"><%= t("projects.index.stock_sheet") %></h2>

    <div class="grid grid-cols-2 gap-3">
      <div>
        <label for="stock_l" class="block text-xs font-light mb-1"><%= t("projects.index.length") %></label>
        <input type="number" id="stock_l" name="stock_l" min="1" step="any" required
               value="<%= @stock_l %>"
               class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label for="stock_w" class="block text-xs font-light mb-1"><%= t("projects.index.width") %></label>
        <input type="number" id="stock_w" name="stock_w" min="1" step="any" required
               value="<%= @stock_w %>"
               class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
  </section>

  <%# Cut Direction %>
  <% if has_feature?(:cut_direction) %>
    <section>
      <h2 class="text-sm font-semibold mb-2 uppercase tracking-wide"><%= t("projects.index.cut_direction") %></h2>
      <select name="cut_direction"
              class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <% %w[auto along_length along_width].each do |dir| %>
          <option value="<%= dir %>" <%= "selected" if (@cut_direction || "auto") == dir %>>
            <%= t("projects.index.cut_directions.#{dir}") %>
          </option>
        <% end %>
      </select>
      <p class="text-xs text-gray-500 mt-1"><%= t("projects.index.cut_direction_hint") %></p>
    </section>
  <% end %>

  <%# Allow Rotation %>
  <section>
    <div class="flex items-center gap-2">
      <input type="hidden" name="allow_rotation" value="0">
      <input type="checkbox" name="allow_rotation" value="1" id="allow_rotation"
             <%= "checked" if @allow_rotation.nil? || @allow_rotation == true || @allow_rotation == "1" %>
             class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-500 focus:ring-blue-500">
      <label for="allow_rotation" class="text-sm font-semibold uppercase tracking-wide"><%= t("projects.index.allow_rotation") %></label>
    </div>
    <p class="text-xs text-gray-500 mt-1"><%= t("projects.index.allow_rotation_hint") %></p>
  </section>

  <%# Kerf %>
  <% if has_feature?(:blade_kerf) %>
    <section>
      <h2 class="text-sm font-semibold mb-2 uppercase tracking-wide"><%= t("projects.index.blade_kerf") %></h2>
      <input type="number" name="kerf" min="0" step="any" value="<%= @kerf || 0 %>"
             class="w-full bg-gray-700 border border-gray-700 rounded px-1.5 py-1 text-sm text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <p class="text-xs text-gray-500 mt-1"><%= t("projects.index.kerf_hint") %></p>
    </section>
  <% end %>

  <button type="submit" data-action="click->form-panel#submitAndCollapse"
          class="w-full bg-white text-gray-950 px-4 py-2 rounded hover:bg-gray-200 font-medium text-sm">
    <%= t("projects.index.optimize") %>
  </button>
<% end %>
