<div class="min-h-screen bg-gray-950 flex items-start justify-center pt-16 px-4">
  <div class="w-full max-w-md">
    <h1 class="text-2xl font-bold text-white mb-8"><%= t("settings.title") %></h1>

    <% if alert.present? %>
      <div class="p-3 mb-4 bg-red-900/50 text-red-300 rounded text-sm"><%= alert %></div>
    <% end %>

    <% if notice.present? %>
      <div class="p-3 mb-4 bg-green-900/50 text-green-300 rounded text-sm"><%= notice %></div>
    <% end %>

    <div data-controller="tabs">
      <%# Tab bar %>
      <div class="flex border-b border-gray-800 mb-6">
        <button type="button" data-tabs-target="tab" data-action="click->tabs#switch"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors">
          <%= t("settings.tabs.language") %>
        </button>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#switch"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors">
          <%= t("settings.tabs.security") %>
        </button>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#switch"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors">
          <%= t("settings.tabs.subscription") %>
        </button>
      </div>

      <%# Language panel %>
      <div data-tabs-target="panel">
        <%= form_with url: locale_path, method: :patch, class: "space-y-6" do |f| %>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1"><%= t("settings.language") %></label>
            <select name="locale"
                    class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-100 text-sm focus:outline-none focus:ring-1 focus:ring-gray-600">
              <% I18n.available_locales.each do |loc| %>
                <option value="<%= loc %>" <%= "selected" if loc == I18n.locale %>>
                  <%= t("locale_selector.#{loc}") %>
                </option>
              <% end %>
            </select>
          </div>

          <button type="submit"
                  class="w-full bg-white text-gray-950 font-semibold py-2 px-4 rounded hover:bg-gray-200 transition-colors text-sm">
            <%= t("settings.save") %>
          </button>
        <% end %>
      </div>

      <%# Security panel %>
      <div data-tabs-target="panel" class="hidden">
        <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put, class: "space-y-6" }) do |f| %>
          <% if resource.errors.any? %>
            <div class="p-3 bg-red-900/50 text-red-300 rounded text-sm">
              <ul class="list-disc list-inside space-y-1">
                <% resource.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <%# Email %>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1"><%= t("settings.email") %></label>
            <%= f.email_field :email, autofocus: true, autocomplete: "email",
                  class: "w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-100 text-sm focus:outline-none focus:ring-1 focus:ring-gray-600" %>
          </div>

          <hr class="border-gray-800">

          <%# New password (optional) %>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1"><%= t("settings.new_password") %></label>
            <%= f.password_field :password, autocomplete: "new-password", placeholder: t("settings.leave_blank"),
                  class: "w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-100 text-sm focus:outline-none focus:ring-1 focus:ring-gray-600 placeholder:text-gray-600" %>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1"><%= t("settings.password_confirmation") %></label>
            <%= f.password_field :password_confirmation, autocomplete: "new-password",
                  class: "w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-100 text-sm focus:outline-none focus:ring-1 focus:ring-gray-600" %>
          </div>

          <hr class="border-gray-800">

          <%# Current password (required) %>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1"><%= t("settings.current_password") %></label>
            <%= f.password_field :current_password, autocomplete: "current-password",
                  class: "w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-gray-100 text-sm focus:outline-none focus:ring-1 focus:ring-gray-600" %>
            <p class="mt-1 text-xs text-gray-500"><%= t("settings.current_password_hint") %></p>
          </div>

          <button type="submit"
                  class="w-full bg-white text-gray-950 font-semibold py-2 px-4 rounded hover:bg-gray-200 transition-colors text-sm">
            <%= t("settings.save") %>
          </button>
        <% end %>
      </div>

      <%# Subscription panel %>
      <div data-tabs-target="panel" class="hidden">
        <div class="space-y-6">
          <%# Current plan %>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"><%= t("settings.subscription.current_plan") %></label>
            <div class="flex items-center gap-3">
              <span class="text-lg font-semibold text-white"><%= t("plans.#{resource.effective_plan}.name") %></span>
              <% if resource.paid_plan? && !resource.one_shot_plan? && !resource.plan_expired? %>
                <span class="text-xs px-2 py-0.5 rounded-full bg-green-500/20 text-green-400 font-medium"><%= t("settings.subscription.active") %></span>
              <% elsif resource.one_shot_plan? %>
                <span class="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 font-medium"><%= t("settings.subscription.one_shot") %></span>
              <% elsif resource.plan_expired? %>
                <span class="text-xs px-2 py-0.5 rounded-full bg-red-500/20 text-red-400 font-medium"><%= t("settings.subscription.expired") %></span>
              <% end %>
            </div>
          </div>

          <%# Plan details %>
          <div class="p-4 bg-gray-900 border border-gray-800 rounded-lg space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-400"><%= t("plans.active_projects") %></span>
              <span class="text-gray-200">
                <% max = resource.max_active_projects %>
                <%= max == Float::INFINITY ? t("plans.unlimited") : max %>
              </span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-400"><%= t("plans.daily_optimizations_per_project") %></span>
              <span class="text-gray-200">
                <% max_opt = resource.max_daily_optimizations_per_project %>
                <%= max_opt == Float::INFINITY ? t("plans.unlimited") : max_opt %>
              </span>
            </div>

            <% if resource.one_shot_plan? %>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400"><%= t("settings.subscription.expires") %></span>
                <span class="text-amber-400"><%= l(resource.plan_expires_at, format: :short) %></span>
              </div>
            <% elsif resource.plan_expires_at.present? && resource.paid_plan? %>
              <div class="flex justify-between text-sm">
                <span class="text-gray-400"><%= t("settings.subscription.ends_on") %></span>
                <span class="text-amber-400"><%= l(resource.plan_expires_at, format: :short) %></span>
              </div>
            <% end %>
          </div>

          <%# Actions %>
          <div class="space-y-3">
            <% has_stripe = resource.stripe_customer_id.present? %>
            <%= button_to t("plans.manage_subscription"), plan_portal_path, method: :post,
                  disabled: !has_stripe,
                  class: "w-full font-semibold py-2 px-4 rounded transition-colors text-sm text-center #{has_stripe ? 'bg-white text-gray-950 hover:bg-gray-200' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}" %>

            <% unless resource.enterprise_plan? %>
              <%= link_to t("sidebar.upgrade"), plans_path,
                    class: "block w-full bg-gray-800 text-white font-semibold py-2 px-4 rounded hover:bg-gray-700 transition-colors text-sm text-center" %>
            <% end %>
          </div>
        </div>
      </div>

    </div>

    <div class="mt-6">
      <%= link_to t("settings.back"), root_path, class: "text-sm text-gray-500 hover:text-gray-300 transition-colors" %>
    </div>
  </div>
</div>
